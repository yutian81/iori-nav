name: Deploy to Cloudflare Pages

on:
  push:
    branches: [ master ]
    paths:
      - 'functions/**'
      - 'public/**'

jobs:
  deploy:
    runs-on: ubuntu-latest
    env:
      CLOUDFLARE_API_TOKEN: ${{ vars.CLOUDFLARE_API_TOKEN }}
      CLOUDFLARE_ACCOUNT_ID: ${{ vars.CLOUDFLARE_ACCOUNT_ID }}
      PROJECT_NAME: ${{ vars.PROJECT_NAME }}
      NAV_D1_NAME: ${{ vars.D1_NAME }}
      NAV_D1_ID: ${{ vars.NAV_D1_ID }}
      NAV_KV_ID: ${{ vars.NAV_KV_ID }}
      ADMIN_USER: ${{ vars.ADMIN_USER }}
      ADMIN_PASS: ${{ vars.ADMIN_PASS }}
      CUSTOM_DOMAIN: ${{ vars.CUSTOM_DOMAIN }}
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install Wrangler
        run: npm install wrangler --save-dev

      - name: Generate Wrangler Config
        shell: bash
        run: |
          # 构建 wrangler.toml
          cat > wrangler.toml <<EOF
          name = "$PROJECT_NAME"
          compatibility_date = "2025-12-01"
          pages_build_output_dir = "public"

          [[d1_databases]]
          binding = "NAV_DB"
          database_name = "$NAV_D1_NAME"
          database_id = "$NAV_D1_ID"

          [[kv_namespaces]]
          binding = "NAV_AUTH"
          id = "$NAV_KV_ID"
          EOF

      - name: Deploy and Initialize
        run: |
          mkdir -p public

          # 执行 D1 数据库初始化
          if [ -f "schema.sql" ]; then
            npx wrangler d1 execute ${NAV_D1_NAME} --remote --file=./schema.sql -y
          fi

          # 部署项目到 Cloudflare Pages
          npx wrangler pages deploy public --project-name ${PROJECT_NAME}

          # 自动写入 KV 管理员账号
          npx wrangler kv:key put --binding=NAV_AUTH "admin_username" "${ADMIN_USER}" --preview false
          npx wrangler kv:key put --binding=NAV_AUTH "admin_password" "${ADMIN_PASS}" --preview false

      - name: Bind Custom Domain
        if: env.CUSTOM_DOMAIN != ''
        run: |
          # 自动绑定自定义域名
          curl -X POST "https://api.cloudflare.com/client/v4/accounts/${CLOUDFLARE_ACCOUNT_ID}/pages/projects/${PROJECT_NAME}/domains" \
               -H "Authorization: Bearer $CLOUDFLARE_API_TOKEN" \
               -H "Content-Type: application/json" \
               --data "{\"name\":\"${CUSTOM_DOMAIN}\"}"
      
