name: è‡ªåŠ¨éƒ¨ç½²åˆ° Cloudflare Pages

on:
  push:
    branches: [ master ]
    paths:
      - 'functions/**'
      - 'public/**'

jobs:
  deploy:
    runs-on: ubuntu-latest
    env:
      CLOUDFLARE_API_TOKEN: ${{ vars.CLOUDFLARE_API_TOKEN }}
      CLOUDFLARE_ACCOUNT_ID: ${{ vars.CLOUDFLARE_ACCOUNT_ID }}
      PROJECT_NAME: ${{ vars.PROJECT_NAME || 'iori-nav' }}
      NAV_D1_NAME: ${{ vars.D1_NAME }}
      NAV_D1_ID: ${{ vars.NAV_D1_ID }}
      NAV_KV_ID: ${{ vars.NAV_KV_ID }}
      ADMIN_USER: ${{ vars.ADMIN_USER || 'admin' }}
      ADMIN_PASS: ${{ vars.ADMIN_PASS || 'admin123' }}
      CUSTOM_DOMAIN: ${{ vars.CUSTOM_DOMAIN }}
    
    steps:
      - name: æ£€å‡ºä»“åº“
        uses: actions/checkout@v4

      - name: å®‰è£… nodejs ç¯å¢ƒ
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: å®‰è£… Wrangler
        run: npm install wrangler --save-dev

      - name: ç”Ÿæˆ Wrangler é…ç½®
        shell: bash
        run: |
          # æ„å»º wrangler.toml
          cat > wrangler.toml <<EOF
          name = "$PROJECT_NAME"
          compatibility_date = "2025-12-01"
          pages_build_output_dir = "public"

          [[d1_databases]]
          binding = "NAV_DB"
          database_name = "$NAV_D1_NAME"
          database_id = "$NAV_D1_ID"

          [[kv_namespaces]]
          binding = "NAV_AUTH"
          id = "$NAV_KV_ID"
          EOF

      - name: éƒ¨ç½²å¹¶åˆå§‹åŒ–æ•°æ®åº“
        id: deploy
        run: |
          mkdir -p public

          # æ‰§è¡Œ D1 æ•°æ®åº“åˆå§‹åŒ–
          if [ -f "schema.sql" ]; then
            npx wrangler d1 execute ${NAV_D1_NAME} --remote --file=./schema.sql -y
          fi

          # éƒ¨ç½²é¡¹ç›®åˆ° Cloudflare Pages
          DEPLOY_OUTPUT=$(npx wrangler pages deploy public --project-name ${PROJECT_NAME})
          PAGES_URL=$(echo "$DEPLOY_OUTPUT" | sed 's/\x1b\[[0-9;]*m//g' | grep -oE "https://[^ ]+\.pages\.dev" | head -n 1)
          echo "PAGES_URL=$PAGES_URL" >> $GITHUB_ENV

          # è‡ªåŠ¨å†™å…¥ KV ç®¡ç†å‘˜è´¦å·
          npx wrangler kv:key put --binding=NAV_AUTH "admin_username" "${ADMIN_USER}" --preview false
          npx wrangler kv:key put --binding=NAV_AUTH "admin_password" "${ADMIN_PASS}" --preview false

      - name: ç»‘å®šè‡ªå®šä¹‰åŸŸå
        if: env.CUSTOM_DOMAIN != ''
        run: |
          # è‡ªåŠ¨ç»‘å®šè‡ªå®šä¹‰åŸŸå
          curl -X POST "https://api.cloudflare.com/client/v4/accounts/${CLOUDFLARE_ACCOUNT_ID}/pages/projects/${PROJECT_NAME}/domains" \
               -H "Authorization: Bearer $CLOUDFLARE_API_TOKEN" \
               -H "Content-Type: application/json" \
               --data "{\"name\":\"${CUSTOM_DOMAIN}\"}"

      - name: è¾“å‡ºéƒ¨ç½²ç»“æœ
        run: |
          echo "=========================================="
          echo "ğŸ‰ğŸ‰ğŸ‰ æ­å–œï¼éƒ¨ç½²å®Œæˆï¼"
          echo "ğŸ”— é»˜è®¤ Pages åœ°å€: ${PAGES_URL}"
          
          if [ -n "${CUSTOM_DOMAIN}" ]; then
            echo "ğŸŒ è‡ªå®šä¹‰åŸŸååœ°å€: https://${CUSTOM_DOMAIN}"
          fi
          
          echo "ğŸ‘¤ ç®¡ç†å‘˜ç”¨æˆ·å: ${ADMIN_USER}"
          echo "ğŸ”‘ ç®¡ç†å‘˜å¯†ç : ${ADMIN_PASS}"
          echo "=========================================="
