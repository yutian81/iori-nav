name: è‡ªåŠ¨éƒ¨ç½²åˆ° Cloudflare Pages

on:
  push:
    branches: [ master ]
    paths:
      - 'functions/**'
      - 'public/**'

jobs:
  deploy:
    runs-on: ubuntu-latest
    env:
      CLOUDFLARE_API_TOKEN: ${{ vars.CLOUDFLARE_API_TOKEN }}
      CLOUDFLARE_ACCOUNT_ID: ${{ vars.CLOUDFLARE_ACCOUNT_ID }}
      PROJECT_NAME: ${{ vars.PROJECT_NAME || 'iori-nav' }}
      NAV_D1_NAME: ${{ vars.NAV_D1_NAME }}
      NAV_D1_ID: ${{ vars.NAV_D1_ID }}
      NAV_KV_ID: ${{ vars.NAV_KV_ID }}
      ADMIN_USER: ${{ vars.ADMIN_USER || 'admin' }}
      ADMIN_PASS: ${{ vars.ADMIN_PASS || 'admin123' }}
      CUSTOM_DOMAIN: ${{ vars.CUSTOM_DOMAIN }}
    
    steps:
      - name: æ£€å‡ºä»“åº“
        uses: actions/checkout@v4

      - name: å®‰è£… nodejs ç¯å¢ƒä¸ CF cli
        run: |
          uses: actions/setup-node@v4
          with:
            node-version: 20
          npm install wrangler --save-dev

      - name: éƒ¨ç½²å¹¶åˆå§‹åŒ–
        id: deploy
        run: |
          mkdir -p public
          
          # ç”Ÿæˆé…ç½®æ–‡ä»¶
          cat > wrangler.toml <<EOF
          name = "$PROJECT_NAME"
          compatibility_date = "2025-12-01"
          pages_build_output_dir = "public"
          [[d1_databases]]
          binding = "NAV_DB"
          database_name = "$NAV_D1_NAME"
          database_id = "$NAV_D1_ID"
          [[kv_namespaces]]
          binding = "NAV_AUTH"
          id = "$NAV_KV_ID"
          EOF

          # æ‰§è¡Œæ•°æ®åº“åˆå§‹åŒ–
          [ -f "schema.sql" ] && npx wrangler d1 execute ${NAV_D1_NAME} --remote --file=./schema.sql -y

          # éƒ¨ç½²å¹¶æå– URL
          DEPLOY_OUTPUT=$(npx wrangler pages deploy public --project-name ${PROJECT_NAME})
          PAGES_URL=$(echo "$DEPLOY_OUTPUT" | sed 's/\x1b\[[0-9;]*m//g' | grep -oE "https://[^ ]+\.pages\.dev" | head -n 1)
          echo "PAGES_URL=$PAGES_URL" >> $GITHUB_ENV

          # å†™å…¥ KV è´¦å·å¯†ç 
          npx wrangler kv:key put --binding=NAV_AUTH "admin_username" "${ADMIN_USER}" --preview false
          npx wrangler kv:key put --binding=NAV_AUTH "admin_password" "${ADMIN_PASS}" --preview false

          # ç»‘å®šåŸŸå
          [ -n "${CUSTOM_DOMAIN}" ] && npx wrangler pages domains create ${PROJECT_NAME} --domain ${CUSTOM_DOMAIN} || true

      - name: è¾“å‡ºç»“æœ
        run: |
          echo "=========================================="
          echo "ğŸ‰ éƒ¨ç½²å®Œæˆï¼"
          echo "ğŸ”— é»˜è®¤ Pages åœ°å€: ${PAGES_URL}"
          [ -n "${CUSTOM_DOMAIN}" ] && echo "ğŸŒ è‡ªå®šä¹‰åŸŸååœ°å€: https://${CUSTOM_DOMAIN}"
          echo "ğŸ‘¤ ç®¡ç†å‘˜ç”¨æˆ·å: ${ADMIN_USER}"
          echo "ğŸ”‘ ç®¡ç†å‘˜å¯†ç : ${ADMIN_PASS}"
          echo "=========================================="
